<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng AusyncLab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #ff6b6b, #4ecdc4);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            background: #ff6b6b;
            transition: background 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background: #ff8787;
        }
        .btn-primary:disabled {
            background: #f87171;
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc2626;
            transition: background 0.2s;
        }
        .btn-danger:hover {
            background: #ef4444;
        }
        .warning {
            background: rgba(255, 255, 0, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .nav-link {
            transition: background 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
        }
        .hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white">
    <nav class="w-full bg-transparent p-4">
        <div class="container mx-auto max-w-md flex justify-around">
            <button id="nav-tts" class="nav-link px-4 py-2 rounded-lg font-semibold text-lg active">Text-to-Speech</button>
            <button id="nav-audio" class="nav-link px-4 py-2 rounded-lg font-semibold text-lg">Quản lý Audio</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="warning">
            <p class="text-yellow-300 text-sm">
                CẢNH BÁO: Nhúng API Key trong JavaScript không an toàn vì nó có thể bị lộ qua Developer Tools. Chỉ dùng cho thử nghiệm cá nhân. Hãy sử dụng proxy server để bảo mật!
            </p>
        </div>

        <!-- Trang Text-to-Speech -->
        <div id="page-tts">
            <h1 class="text-3xl font-bold text-center mb-6">Giọng Nói Hoạt Ngôn</h1>
            
            <div class="glass-effect p-6 mb-6">
                <textarea id="textInput" 
                    class="w-full h-40 p-4 text-gray-800 rounded-lg bg-white/90 focus:outline-none focus:ring-2 focus:ring-pink-400 resize-none"
                    placeholder="Nhập văn bản tiếng Việt để nghe giọng cô gái hoạt ngôn..."></textarea>
            </div>

            <div class="glass-effect p-4 mb-6">
                <label for="voiceSelect" class="block text-sm font-medium mb-2">Chọn giọng nói:</label>
                <select id="voiceSelect" 
                    class="w-full p-2 rounded-lg bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <!-- Voice options will be dynamically populated -->
                </select>
            </div>

            <div class="glass-effect p-4 mb-6">
                <label for="rate" class="block text-sm font-medium mb-2">Tốc độ giọng nói:</label>
                <input type="range" id="rate" min="0.75" max="1.25" step="0.05" value="1" 
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <span id="rateValue" class="text-sm">1</span>
            </div>

            <button id="speakButton" onclick="speak()" 
                class="w-full py-3 btn-primary rounded-lg font-semibold text-lg flex justify-center items-center">
                Phát Giọng Nói
                <span id="speakSpinner" class="spinner hidden"></span>
            </button>
        </div>

        <!-- Trang Quản lý Audio -->
        <div id="page-audio" class="hidden">
            <h1 class="text-3xl font-bold text-center mb-6">Quản lý Audio</h1>
            <div id="audioList" class="space-y-4">
                <!-- Audio items will be dynamically populated -->
            </div>
            <button onclick="loadAudioList()" 
                class="w-full py-3 btn-primary rounded-lg font-semibold text-lg mt-6">
                Tải Lại Danh Sách
            </button>
        </div>
    </div>

    <script>
        const API_KEY = 'dftEboBnvewB5Scxl-7EpTTSFEGbBlN2VfwSArjGaOxHhytpj_fg4etmHaPzK5d9QMBSyU3Y2LXQ7t3BAe6e1g';
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateInput = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pageTts = document.getElementById('page-tts');
        const pageAudio = document.getElementById('page-audio');
        const navTts = document.getElementById('nav-tts');
        const navAudio = document.getElementById('nav-audio');
        const audioList = document.getElementById('audioList');
        const speakButton = document.getElementById('speakButton');
        const speakSpinner = document.getElementById('speakSpinner');

        // Navigation
        navTts.addEventListener('click', () => {
            pageTts.classList.remove('hidden');
            pageAudio.classList.add('hidden');
            navTts.classList.add('active');
            navAudio.classList.remove('active');
        });

        navAudio.addEventListener('click', () => {
            pageTts.classList.add('hidden');
            pageAudio.classList.remove('hidden');
            navTts.classList.remove('active');
            navAudio.classList.add('active');
            loadAudioList();
        });

        // Update slider value displays
        rateInput.addEventListener('input', () => {
            rateValue.textContent = rateInput.value;
        });

        // Fetch available voices
        async function loadVoices() {
            try {
                const response = await fetch('https://api.ausynclab.org/api/v1/voices/list', {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi lấy danh sách giọng nói: ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
                const voices = data.result;
                voiceSelect.innerHTML = '';
                
                const vietnameseFemaleVoices = voices.filter(voice => 
                    voice.language === 'vi' && 
                    voice.gender === 'FEMALE' && 
                    voice.age === 'YOUNG' && 
                    ['CASUAL', 'ADVERTISEMENT'].includes(voice.use_case)
                );

                if (vietnameseFemaleVoices.length === 0) {
                    const warning = document.createElement('p');
                    warning.className = 'text-yellow-300 text-sm mt-2';
                    warning.textContent = 'Lưu ý: Không tìm thấy giọng nữ tiếng Việt phù hợp. Vui lòng liên hệ AusyncLab (admin@ausynclab.io).';
                    voiceSelect.parentNode.appendChild(warning);
                }

                vietnameseFemaleVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = `${voice.name} (Nữ, Trẻ trung, ${voice.use_case === 'ADVERTISEMENT' ? 'Quảng cáo' : 'Thân mật'})`;
                    if (voice.id === 373762) { // Ái My
                        option.selected = true;
                    }
                    voiceSelect.appendChild(option);
                });

                voices.filter(voice => !vietnameseFemaleVoices.includes(voice)).forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = `${voice.name} (${voice.language}, ${voice.gender}, ${voice.age}, ${voice.use_case})`;
                    voiceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi:', error);
                const warning = document.createElement('p');
                warning.className = 'text-yellow-300 text-sm mt-2';
                warning.textContent = `Lỗi khi tải danh sách giọng nói: ${error.message}. Vui lòng kiểm tra kết nối mạng hoặc liên hệ AusyncLab.`;
                voiceSelect.parentNode.appendChild(warning);
            }
        }

        // Text-to-Speech
        async function speak() {
            const text = textInput.value;
            if (text.trim() === '') {
                alert('Vui lòng nhập văn bản!');
                return;
            }

            // Show loading state
            speakButton.disabled = true;
            speakSpinner.classList.remove('hidden');

            const voiceId = voiceSelect.value;
            const speed = parseFloat(rateInput.value);

            try {
                // Step 1: Create audio job
                const createResponse = await fetch('https://api.ausynclab.org/api/v1/speech/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        audio_name: text,
                        text: text,
                        voice_id: voiceId,
                        speed: speed,
                        callback_url: ''
                    })
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Lỗi khi tạo audio job: ${JSON.stringify(errorData)}`);
                }

                const createData = await createResponse.json();
                const audioId = createData.result.audio_id;

                // Step 2: Poll audio status until SUCCEED
                let audioUrl = null;
                const maxAttempts = 10;
                let attempts = 0;

                while (attempts < maxAttempts) {
                    const statusResponse = await fetch(`https://api.ausynclab.org/api/v1/speech/${audioId}`, {
                        method: 'GET',
                        headers: {
                            'accept': 'application/json',
                            'X-API-Key': API_KEY
                        }
                    });

                    if (!statusResponse.ok) {
                        const errorData = await statusResponse.json();
                        throw new Error(`Lỗi khi lấy trạng thái audio: ${JSON.stringify(errorData)}`);
                    }

                    const statusData = await statusResponse.json();
                    if (statusData.result.state === 'SUCCEED') {
                        audioUrl = statusData.result.audio_url;
                        break;
                    } else if (statusData.result.state === 'FAILED') {
                        throw new Error('Tạo audio thất bại. Vui lòng thử lại.');
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (!audioUrl) {
                    throw new Error('Hết thời gian chờ audio. Vui lòng thử lại.');
                }

                // Step 3: Play audio
                const audio = new Audio(audioUrl);
                audio.play().catch(error => {
                    throw new Error(`Lỗi phát audio: ${error.message}`);
                });
            } catch (error) {
                console.error('Lỗi:', error);
                alert(`Đã xảy ra lỗi khi chuyển văn bản thành giọng nói: ${error.message}. Vui lòng kiểm tra kết nối mạng hoặc liên hệ AusyncLab.`);
            } finally {
                // Hide loading state
                speakButton.disabled = false;
                speakSpinner.classList.add('hidden');
            }
        }

        // Load voices on page load
        loadVoices();

        // Fetch and display audio list
        async function loadAudioList() {
            try {
                const response = await fetch('https://api.ausynclab.org/api/v1/speech/', {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi lấy danh sách audio: ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
                const audios = data.result;
                audioList.innerHTML = '';

                if (audios.length === 0) {
                    const warning = document.createElement('p');
                    warning.className = 'text-yellow-300 text-sm';
                    warning.textContent = 'Không có audio nào trong danh sách.';
                    audioList.appendChild(warning);
                    return;
                }

                audios.forEach(audio => {
                    const audioCard = document.createElement('div');
                    audioCard.className = 'glass-effect p-4';
                    audioCard.innerHTML = `
                        <p><strong>Tên:</strong> ${audio.name}</p>
                        <p><strong>Giọng:</strong> ${audio.voice_name}</p>
                        <p><strong>Tốc độ:</strong> ${audio.speed}</p>
                        <p><strong>Ngày tạo:</strong> ${new Date(audio.created_at).toLocaleString('vi-VN')}</p>
                        <p><strong>Trạng thái:</strong> ${audio.state}</p>
                        <button onclick="playAudio('${audio.audio_url}')" 
                            class="w-full py-2 btn-primary rounded-lg font-semibold mt-2">
                            Phát Audio
                        </button>
                        <button onclick="deleteAudio(${audio.id})" 
                            class="w-full py-2 btn-danger rounded-lg font-semibold mt-2">
                            Xóa Audio
                        </button>
                    `;
                    audioList.appendChild(audioCard);
                });
            } catch (error) {
                console.error('Lỗi:', error);
                const warning = document.createElement('p');
                warning.className = 'text-yellow-300 text-sm';
                warning.textContent = `Lỗi khi tải danh sách audio: ${error.message}. Vui lòng kiểm tra kết nối mạng hoặc liên hệ AusyncLab.`;
                audioList.appendChild(warning);
            }
        }

        // Play audio
        function playAudio(url) {
            const audio = new Audio(url);
            audio.play().catch(error => {
                console.error('Lỗi phát audio:', error);
                alert('Không thể phát audio. Vui lòng kiểm tra URL hoặc kết nối mạng.');
            });
        }

        // Delete audio (assumed endpoint)
        async function deleteAudio(audioId) {
            if (!confirm('Bạn có chắc muốn xóa audio này?')) return;
            try {
                const response = await fetch(`https://api.ausynclab.org/api/v1/speech/${audioId}`, {
                    method: 'DELETE',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi xóa audio: ${JSON.stringify(errorData)}`);
                }
                alert('Xóa audio thành công!');
                loadAudioList();
            } catch (error) {
                console.error('Lỗi:', error);
                alert(`Lỗi khi xóa audio: ${error.message}. Vui lòng liên hệ AusyncLab để xác nhận endpoint DELETE.`);
            }
        }
    </script>
</body>
</html>