<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng AusyncLab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #ff6b6b, #4ecdc4);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(12px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            background: #ff6b6b;
            transition: background 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background: #ff8787;
        }
        .btn-primary:disabled {
            background: #f87171;
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #dc2626;
            transition: background 0.2s;
        }
        .btn-danger:hover {
            background: #ef4444;
        }
        .warning {
            background: rgba(255, 255, 0, 0.2);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .nav-link {
            transition: background 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
        }
        .hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .pagination-button {
            min-width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1rem;
            transition: background 0.2s;
            cursor: pointer;
        }
        .pagination-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.4);
        }
        .pagination-button.active {
            background: #ff6b6b;
            font-weight: bold;
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-ellipsis {
            color: white;
            font-size: 1rem;
            padding: 0.5rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid #ff6b6b;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        .sync-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.5rem;
            background: #ff6b6b;
            transition: background 0.2s;
        }
        .sync-button:hover:not(:disabled) {
            background: #ff8787;
        }
        .sync-button:disabled {
            background: #f87171;
            opacity: 0.6;
            cursor: not-allowed;
        }
        .sync-icon {
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        .sync-icon.paused {
            animation-play-state: paused;
        }
        @media (max-width: 640px) {
            .pagination {
                gap: 0.25rem;
            }
            .pagination-button {
                min-width: 2rem;
                height: 2rem;
                font-size: 0.875rem;
            }
            .sync-button {
                width: 2rem;
                height: 2rem;
            }
            .sync-icon {
                width: 1.25rem;
                height: 1.25rem;
            }
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="text-white">
    <nav class="w-full bg-transparent p-4">
        <div class="container mx-auto max-w-md flex justify-around">
            <button id="nav-tts" class="nav-link px-4 py-2 rounded-lg font-semibold text-lg active">Chuyển đổi</button>
            <button id="nav-audio" class="nav-link px-4 py-2 rounded-lg font-semibold text-lg">Quản lý Audio</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay hidden">
            <div class="loading-spinner"></div>
        </div>

        <!-- Trang Text-to-Speech -->
        <div id="page-tts">
            <div class="glass-effect p-6 mb-6">
                <textarea id="textInput" 
                    class="w-full h-40 p-4 text-gray-800 rounded-lg bg-white/90 focus:outline-none focus:ring-2 focus:ring-pink-400 resize-none"
                    placeholder="Nhập văn bản tiếng Việt ..."></textarea>
            </div>

            <div class="glass-effect p-4 mb-6">
                <label for="voiceSelect" class="block text-sm font-medium mb-2">Chọn giọng nói:</label>
                <select id="voiceSelect" 
                    class="w-full p-2 rounded-lg bg-white/90 text-gray-800 focus:outline-none focus:ring-2 focus:ring-pink-400">
                </select>
            </div>

            <div class="glass-effect p-4 mb-6">
                <label for="rate" class="block text-sm font-medium mb-2">Tốc độ giọng nói:</label>
                <input type="range" id="rate" min="0.75" max="1.25" step="0.05" value="1" 
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <span id="rateValue" class="text-sm">1</span>
            </div>

            <div class="flex space-x-4">
                <button id="speakButton" onclick="speak()" 
                    class="w-full py-3 btn-primary rounded-lg font-semibold text-lg flex justify-center items-center">
                    Phát Giọng Nói
                    <span id="speakSpinner" class="spinner hidden"></span>
                </button>
                <button id="addAudioButton" onclick="addAudio()" 
                    class="w-full py-3 btn-primary rounded-lg font-semibold text-lg flex justify-center items-center">
                    Thêm Audio
                    <span id="addAudioSpinner" class="spinner hidden"></span>
                </button>
            </div>
        </div>

        <!-- Trang Quản lý Audio -->
        <div id="page-audio" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-center">Quản lý Audio</h1>
                <button id="syncButton" class="sync-button" title="Đồng bộ danh sách" onclick="fetchAudioList()">
                    <svg id="syncIcon" class="sync-icon paused" fill="none" stroke="white" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5m0 10h-5v5m16-10v5h-5m0-10h5v-5"></path>
                    </svg>
                </button>
            </div>
            <div id="audioList" class="space-y-4"></div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>

    <script>
        const API_KEY = 'dftEboBnvewB5Scxl-7EpTTSFEGbBlN2VfwSArjGaOxHhytpj_fg4etmHaPzK5d9QMBSyU3Y2LXQ7t3BAe6e1g';
        const textInput = document.getElementById('textInput');
        const voiceSelect = document.getElementById('voiceSelect');
        const rateInput = document.getElementById('rate');
        const rateValue = document.getElementById('rateValue');
        const pageTts = document.getElementById('page-tts');
        const pageAudio = document.getElementById('page-audio');
        const navTts = document.getElementById('nav-tts');
        const navAudio = document.getElementById('nav-audio');
        const audioList = document.getElementById('audioList');
        const speakButton = document.getElementById('speakButton');
        const speakSpinner = document.getElementById('speakSpinner');
        const addAudioButton = document.getElementById('addAudioButton');
        const addAudioSpinner = document.getElementById('addAudioSpinner');
        const syncButton = document.getElementById('syncButton');
        const syncIcon = document.getElementById('syncIcon');
        const pagination = document.getElementById('pagination');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Pagination state
        let currentPage = 1;
        const itemsPerPage = 3;
        let allAudios = [];
        let autoRefreshInterval = null;

        // Show/hide loading overlay
        function toggleLoadingOverlay(show) {
            loadingOverlay.classList.toggle('hidden', !show);
            document.body.style.pointerEvents = show ? 'none' : 'auto';
            syncIcon.classList.toggle('paused', !show);
            syncButton.disabled = show;
        }

        // Start auto-refresh for audio list
        function startAutoRefresh() {
            if (!autoRefreshInterval) {
                autoRefreshInterval = setInterval(() => {
                    if (!pageAudio.classList.contains('hidden')) {
                        fetchAudioList();
                    }
                }, 60000); // 60 seconds
            }
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Navigation
        navTts.addEventListener('click', () => {
            pageTts.classList.remove('hidden');
            pageAudio.classList.add('hidden');
            navTts.classList.add('active');
            navAudio.classList.remove('active');
            stopAutoRefresh();
        });

        navAudio.addEventListener('click', () => {
            pageTts.classList.add('hidden');
            pageAudio.classList.remove('hidden');
            navTts.classList.remove('active');
            navAudio.classList.add('active');
            fetchAudioList();
            startAutoRefresh();
        });

        // Update slider value displays
        rateInput.addEventListener('input', () => {
            rateValue.textContent = rateInput.value;
        });

        // Fetch available voices
        async function loadVoices() {
            try {
                const response = await fetch('https://api.ausynclab.org/api/v1/voices/list', {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi lấy danh sách giọng nói: ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
                const voices = data.result;
                voiceSelect.innerHTML = '';

                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = `${voice.name} (${genText(voice.language)}, ${genText(voice.gender)}, ${genText(voice.age)})`;
                    voiceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi:', error);
                const warning = document.createElement('p');
                warning.className = 'text-yellow-300 text-sm mt-2';
                warning.textContent = `Lỗi khi tải danh sách giọng nói: ${error.message}. Vui lòng kiểm tra kết nối mạng hoặc liên hệ AusyncLab.`;
                voiceSelect.parentNode.appendChild(warning);
            }
        }

        function genText(text) {
            if (text == 'vi') return 'VN';
            if (text == 'FEMALE') return 'Nữ';
            if (text == 'MALE') return 'Nam';
            if (text == 'YOUNG') return 'Trẻ';
            if (text == 'MIDDLE_AGED') return 'Trung niên';
            if (text == 'OLD') return 'Già';
            return text

        }

        // Text-to-Speech (Speak and Play)
        async function speak() {
            const text = textInput.value;
            if (text.trim() === '') {
                alert('Vui lòng nhập văn bản!');
                return;
            }

            speakButton.disabled = true;
            speakSpinner.classList.remove('hidden');
            toggleLoadingOverlay(true);

            const voiceId = voiceSelect.value;
            const speed = parseFloat(rateInput.value);

            try {
                const createResponse = await fetch('https://api.ausynclab.org/api/v1/speech/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        audio_name: text,
                        text: text,
                        voice_id: voiceId,
                        speed: speed,
                        callback_url: ''
                    })
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Lỗi khi tạo audio job: ${JSON.stringify(errorData)}`);
                }

                const createData = await createResponse.json();
                const audioId = createData.result.audio_id;

                let audioUrl = null;
                const maxAttempts = 5;
                let attempts = 0;

                while (attempts < maxAttempts) {
                    const statusResponse = await fetch(`https://api.ausynclab.org/api/v1/speech/${audioId}`, {
                        method: 'GET',
                        headers: {
                            'accept': 'application/json',
                            'X-API-Key': API_KEY
                        }
                    });

                    if (!statusResponse.ok) {
                        const errorData = await statusResponse.json();
                        throw new Error(`Lỗi khi lấy trạng thái audio: ${JSON.stringify(errorData)}`);
                    }

                    const statusData = await statusResponse.json();
                    if (statusData.result.state === 'SUCCEED') {
                        audioUrl = statusData.result.audio_url;
                        break;
                    } else if (statusData.result.state === 'FAILED') {
                        throw new Error('Tạo audio thất bại. Vui lòng thử lại.');
                    }

                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (!audioUrl) {
                    throw new Error('Hết thời gian chờ audio. Vui lòng thử lại.');
                }

                const audio = new Audio(audioUrl);
                audio.play().catch(error => {
                    throw new Error(`Lỗi phát audio: ${error.message}`);
                });
                await fetchAudioList();
            } catch (error) {
                console.error('Lỗi:', error);
                alert(`Hệ thống đang xử lý. Hãy vào phần quản lý để xem lại trạng thái`);
            } finally {
                speakButton.disabled = false;
                speakSpinner.classList.add('hidden');
                toggleLoadingOverlay(false);
            }
        }

        // Text-to-Speech (Add Audio without waiting)
        async function addAudio() {
            const text = textInput.value;
            if (text.trim() === '') {
                alert('Vui lòng nhập văn bản!');
                return;
            }

            addAudioButton.disabled = true;
            addAudioSpinner.classList.remove('hidden');
            toggleLoadingOverlay(true);

            const voiceId = voiceSelect.value;
            const speed = parseFloat(rateInput.value);

            try {
                const createResponse = await fetch('https://api.ausynclab.org/api/v1/speech/text-to-speech', {
                    method: 'POST',
                    headers: {
                        'accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        audio_name: text,
                        text: text,
                        voice_id: voiceId,
                        speed: speed,
                        callback_url: ''
                    })
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Lỗi khi tạo audio job: ${JSON.stringify(errorData)}`);
                }

                // Switch to Audio Management page
                pageTts.classList.add('hidden');
                pageAudio.classList.remove('hidden');
                navTts.classList.remove('active');
                navAudio.classList.add('active');
                await fetchAudioList();
                startAutoRefresh();
            } catch (error) {
                console.error('Lỗi:', error);
                alert(`Lỗi khi thêm audio: ${error.message}. Hãy vào phần quản lý để xem lại trạng thái.`);
            } finally {
                addAudioButton.disabled = false;
                addAudioSpinner.classList.add('hidden');
                toggleLoadingOverlay(false);
            }
        }

        // Render pagination
        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.className = 'pagination-button';
            prevButton.textContent = '«';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderAudioList();
                }
            };
            pagination.appendChild(prevButton);

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstPage = document.createElement('button');
                firstPage.className = 'pagination-button';
                firstPage.textContent = '1';
                firstPage.onclick = () => {
                    currentPage = 1;
                    renderAudioList();
                };
                pagination.appendChild(firstPage);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.className = `pagination-button ${i === currentPage ? 'active' : ''}`;
                pageButton.textContent = i;
                pageButton.onclick = () => {
                    currentPage = i;
                    renderAudioList();
                };
                pagination.appendChild(pageButton);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    pagination.appendChild(ellipsis);
                }

                const lastPage = document.createElement('button');
                lastPage.className = 'pagination-button';
                lastPage.textContent = totalPages;
                lastPage.onclick = () => {
                    currentPage = totalPages;
                    renderAudioList();
                };
                pagination.appendChild(lastPage);
            }

            const nextButton = document.createElement('button');
            nextButton.className = 'pagination-button';
            nextButton.textContent = '»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderAudioList();
                }
            };
            pagination.appendChild(nextButton);
        }

        // Fetch and store audio list
        async function fetchAudioList() {
            toggleLoadingOverlay(true);
            syncButton.disabled = true;
            try {
                const response = await fetch('https://api.ausynclab.org/api/v1/speech/', {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi lấy danh sách audio: ${JSON.stringify(errorData)}`);
                }
                const data = await response.json();
                allAudios = data.result;
                currentPage = 1;
                renderAudioList();
            } catch (error) {
                console.error('Lỗi:', error);
                const warning = document.createElement('p');
                warning.className = 'text-yellow-300 text-sm';
                warning.textContent = `Lỗi khi tải danh sách audio: ${error.message}. Vui lòng kiểm tra kết nối mạng hoặc liên hệ AusyncLab.`;
                audioList.appendChild(warning);
                pagination.innerHTML = '';
            } finally {
                toggleLoadingOverlay(false);
                syncButton.disabled = false;
            }
        }

        // Render audio list from stored data
        function renderAudioList() {
            audioList.innerHTML = '';

            if (allAudios.length === 0) {
                const warning = document.createElement('p');
                warning.className = 'text-yellow-300 text-sm';
                warning.textContent = 'Không có audio nào trong danh sách.';
                audioList.appendChild(warning);
                pagination.innerHTML = '';
                return;
            }

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAudios = allAudios.slice(startIndex, endIndex);

            paginatedAudios.forEach(audio => {
                const audioCard = document.createElement('div');
                audioCard.className = 'glass-effect p-4';
                audioCard.innerHTML = `
                    <p><strong>Tên:</strong> ${audio.name}</p>
                    <p><strong>Giọng:</strong> ${audio.voice_name}</p>
                    <p><strong>Tốc độ:</strong> ${audio.speed}</p>
                    <p><strong>Ngày tạo:</strong> ${new Date(audio.created_at).toLocaleString('vi-VN')}</p>
                    <p><strong>Trạng thái:</strong> ${getStatus(audio.state)}</p>
                    <button onclick="download('${audio.audio_url}')" 
                        class="w-full py-2 btn-primary rounded-lg font-semibold mt-2 ${audio.state != 'SUCCEED' ? 'hidden' : ''}">
                        Tải về
                    </button>
                    <button onclick="playAudio('${audio.audio_url}')" 
                        class="w-full py-2 btn-primary rounded-lg font-semibold mt-2 ${audio.state != 'SUCCEED' ? 'hidden' : ''}">
                        Phát
                    </button>
                    <button onclick="deleteAudio(${audio.id})" 
                        class="w-full py-2 btn-danger rounded-lg font-semibold mt-2">
                        Xóa Audio
                    </button>
                `;
                audioList.appendChild(audioCard);
            });

            renderPagination(allAudios.length);
        }

        // Play audio
        function playAudio(url) {
            const audio = new Audio(url);
            audio.play().catch(error => {
                console.error('Lỗi phát audio:', error);
                alert('Không thể phát audio. Vui lòng kiểm tra URL hoặc kết nối mạng.');
            });
        }

        // Delete audio
        async function deleteAudio(audioId) {
            if (!confirm('Bạn có chắc muốn xóa audio này?')) return;
            toggleLoadingOverlay(true);
            try {
                const response = await fetch(`https://api.ausynclab.org/api/v1/speech/${audioId}`, {
                    method: 'DELETE',
                    headers: {
                        'accept': 'application/json',
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Lỗi khi xóa audio: ${JSON.stringify(errorData)}`);
                }
                alert('Xóa audio thành công!');
                allAudios = allAudios.filter(audio => audio.id !== audioId);
                if ((currentPage - 1) * itemsPerPage >= allAudios.length && currentPage > 1) {
                    currentPage--;
                }
                renderAudioList();
            } catch (error) {
                console.error('Lỗi:', error);
                alert(`Lỗi khi xóa audio: ${error.message}. Vui lòng liên hệ AusyncLab để xác nhận endpoint DELETE.`);
            } finally {
                toggleLoadingOverlay(false);
            }
        }

        // Download audio
        function download(url) {
            window.open(url);
        }

        // Get status text
        function getStatus(status) {
            if (status === 'SUCCEED') {
                return 'Thành công';
            }
            if (status === 'FAILED') {
                return 'Thất bại';
            }
            return 'Đang xử lý';
        }

        // Load voices on page load
        loadVoices();
    </script>
</body>
</html>